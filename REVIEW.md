# 実装レビュー（問題点）

以下は現状実装のレビュー結果（問題点）です。重要度の高い順に記載しています。

## 指摘事項

1. **High: アップロードファイルのサイズ無制限 + メモリ一括読込**
   - 場所: `src/app/main.py:223-270`
   - 問題: `/audio_chunk` が `file.read()` で全量をメモリに読み込み、サイズ制限が無いため DoS/メモリ枯渇のリスクがあります。
   - 対応案: ストリーミング処理、サイズ上限の設定、`tmp_audio` の掃除ポリシー追加。

2. **Medium: WebSocket が JSON 専用で `PING` テキストに弱い**
   - 場所: `src/app/main.py:307-315`
   - 問題: `receive_json()` を使っているため、テキストの `PING` を送ると例外で切断される可能性があります。
   - 対応案: `receive_text()` を併用、または JSON パース失敗時のフォールバック処理を追加。

3. **Medium: LLM の RAW 出力を常時クライアントへ返す**
   - 場所: `src/nlp/openai_questions.py:350-357`
   - 問題: 生成結果の生データが `notes` に常時含まれ、情報漏えいやUI劣化の可能性があります。
   - 対応案: デバッグモードのみで返す／短縮・削除。

4. **Low: 到達不能コードが残存**
   - 場所: `src/nlp/openai_questions.py:148-169`
   - 問題: `_parse_last_json_object` 内に未定義変数 (`s2`, `idx`) を含む死コードが残っており、将来の保守ミスを誘発します。
   - 対応案: 該当ブロックを削除して簡素化。

5. **Low: 自動テスト未整備**
   - 問題: 回帰検出が難しく、API変更の安全性が低下します。
   - 対応案: `tests/` を追加し、主要APIのスモークテストを最低限作成。

## 追加確認事項（質問）
- `/audio_chunk` は本番想定か、ローカル実験用途か（サイズ制限・認証方針が変わる）。
- WebSocket の `PING` は JSON 文字列想定か、プレーンテキスト想定か。
- LLM の RAW 出力はデバッグ専用か、仕様として返す必要があるか。
